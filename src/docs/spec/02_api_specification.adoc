:jbake-title: API Specification
:jbake-type: page_toc
:jbake-status: published
:jbake-order: 2
ifndef::imagesdir[:imagesdir: ../../images]

:toc:

= dacli - API Specification
:sectnums:
:icons: font

== Overview

This specification defines the MCP tools provided by dacli. The tools are available via two interfaces:

* **MCP Server** (`dacli-mcp`): For LLM integration via MCP protocol over stdio
* **CLI** (`dacli`): For direct command-line usage (see `06_cli_specification.adoc`)

=== MCP Communication

[source]
----
Transport: stdio (standard input/output)
Protocol: MCP (Model Context Protocol)
----

The MCP server is spawned as a subprocess by an MCP client (e.g., Claude Desktop) and communicates via JSON-RPC over stdio.

=== Authentication

[NOTE]
====
The current version does not require authentication (single-tenant, local access only).
====

== Data Models

=== SectionLocation

Describes the position of a section in a source file.

[source,json]
----
{
  "file": "string",        // Relative path to file
  "start_line": "integer", // 1-based start line
  "end_line": "integer"    // 1-based end line (inclusive)
}
----

=== Section

Represents a section in the document.

[source,json]
----
{
  "path": "string",           // Hierarchical path (e.g., "chapter-1.section-2")
  "title": "string",          // Section title
  "level": "integer",         // Nesting depth (1 = chapter)
  "location": "SectionLocation",
  "children": ["Section"]     // Subsections (optional)
}
----

=== Element

Represents a special element (table, code, diagram).

[source,json]
----
{
  "type": "string",           // "table" | "code" | "diagram" | "list" | "image"
  "path": "string",           // Path to containing section
  "index": "integer",         // Index within section
  "location": "SectionLocation"
}
----

=== SearchResult

Search result with context.

[source,json]
----
{
  "path": "string",           // Path to match location
  "line": "integer",          // Line number
  "context": "string",        // Surrounding text
  "score": "number"           // Relevance score (0-1)
}
----

=== Metadata

Metadata of a document or section.

[source,json]
----
{
  "path": "string",           // Path (or null for project)
  "file": "string",           // Source file
  "word_count": "integer",    // Word count
  "last_modified": "datetime",// Last modified (ISO 8601)
  "subsection_count": "integer",
  "includes": ["string"]      // List of include paths
}
----

=== ValidationResult

Result of structure validation.

[source,json]
----
{
  "valid": "boolean",
  "errors": [{
    "type": "string",         // "unresolved_include" | "circular_include" | ...
    "path": "string",
    "message": "string"
  }],
  "warnings": [{
    "type": "string",
    "path": "string", 
    "message": "string"
  }]
}
----

=== ErrorResponse

Standardized error response.

[source,json]
----
{
  "error": {
    "code": "string",         // Error code (e.g., "PATH_NOT_FOUND")
    "message": "string",      // Human-readable error message
    "details": "object"       // Additional details (optional)
  }
}
----

== MCP Tools

=== Navigation Tools

==== get_structure

Retrieves the hierarchical document structure.

**Use Case:** UC-01

[cols="1,3"]
|===
| Parameter | Description

| `max_depth` (int, optional)
| Maximum depth of returned structure. Default: unlimited.
|===

**Response 200:**
[source,json]
----
{
  "root": {
    "path": "",
    "title": "MCP Documentation Server",
    "level": 0,
    "children": [
      {
        "path": "introduction",
        "title": "1. Introduction",
        "level": 1,
        "children": [
          {
            "path": "introduction.goals",
            "title": "1.1 Goals",
            "level": 2,
            "children": []
          }
        ]
      }
    ]
  },
  "total_sections": 42
}
----

'''

==== get_section

Reads the content of a specific section.

**Use Case:** UC-02

[cols="1,3"]
|===
| Parameter | Description

| `path` (string, required)
| Hierarchical path to section (e.g., "introduction.goals")
|===

**Response 200:**
[source,json]
----
{
  "path": "introduction.goals",
  "title": "1.1 Goals",
  "content": "= Goals\n\nThe main goals of this project are...",
  "location": {
    "file": "chapters/01_introduction.adoc",
    "start_line": 15,
    "end_line": 42
  },
  "format": "asciidoc"
}
----

**Response 404:**
[source,json]
----
{
  "error": {
    "code": "PATH_NOT_FOUND",
    "message": "Section 'introduction.goals' not found",
    "details": {
      "requested_path": "introduction.goals",
      "suggestions": ["introduction.quality-goals", "introduction.stakeholders"]
    }
  }
}
----

'''

==== get_sections_at_level

Retrieves all sections at a specific level.

**Use Case:** UC-01 (Extension)

[cols="1,3"]
|===
| Parameter | Description

| `level` (int, required)
| Desired nesting depth (1 = chapter)
|===

**Response 200:**
[source,json]
----
{
  "level": 1,
  "sections": [
    {
      "path": "introduction",
      "title": "1. Introduction"
    },
    {
      "path": "constraints",
      "title": "2. Constraints"
    }
  ],
  "count": 12
}
----

=== Content Access Tools

==== get_elements

Retrieves elements of a specific type.

**Use Case:** UC-05

[cols="1,3"]
|===
| Parameter | Description

| `element_type` (string, optional)
| Element type: `code`, `table`, `image`, `diagram`, `list`, `admonition`, `plantuml`. None returns all elements.

| `section_path` (string, optional)
| Restriction to specific section
|===

**Response 200:**
[source,json]
----
{
  "type": "code",
  "elements": [
    {
      "type": "code",
      "path": "architecture.decisions",
      "index": 0,
      "location": {
        "file": "chapters/09_decisions.adoc",
        "start_line": 25,
        "end_line": 35
      },
      "attributes": {
        "language": "python",
        "content": "def example():\n    return 'hello world'"
      }
    }
  ],
  "count": 1
}
----

NOTE: The `attributes` field contains element-specific data including content (Issue #159).
For `code` elements, it includes `language` and `content` fields.
For `table` elements, it includes `columns`, `rows`, and `content` (raw table text).
For `list` elements, it includes `list_type` and `content` (all list items).
For `image` elements, it includes `alt`, `src`/`target`, and optionally `title`.
For `plantuml`/diagram elements, it includes `format`, optionally `name`, and `content` (diagram source).
For `admonition` elements, it includes `admonition_type` and `content`.
----

**Response 400:**
[source,json]
----
{
  "error": {
    "code": "INVALID_TYPE",
    "message": "Unknown element type 'charts'",
    "details": {
      "valid_types": ["diagram", "table", "code", "list", "image"]
    }
  }
}
----

'''

==== search

Searches documentation content.

**Use Case:** UC-04

[cols="1,3"]
|===
| Parameter | Description

| `query` (string, required)
| Search term (case-insensitive)

| `scope` (string, optional)
| Restriction to path prefix (e.g., "/architecture")

| `max_results` (int, optional)
| Maximum results to return (default: 20)
|===

**Response 200:**
[source,json]
----
{
  "query": "atomic write",
  "results": [
    {
      "path": "decisions.adr-004",
      "line": 12,
      "context": "...implements atomic writes using a backup-and-replace strategy...",
      "score": 0.95
    },
    {
      "path": "runtime.update-scenario",
      "line": 5,
      "context": "...The process must be atomic to ensure data integrity...",
      "score": 0.78
    }
  ],
  "total_results": 2,
  "search_time_ms": 45
}
----

=== Content Manipulation Tools

==== update_section

Updates the content of a section.

**Use Case:** UC-03

[cols="1,3"]
|===
| Parameter | Description

| `path` (string, required)
| Hierarchical path to section (e.g., "introduction.goals")

| `content` (string, required)
| New section content

| `preserve_title` (bool, optional)
| Keep original title (default: true)

| `expected_hash` (string, optional)
| Hash for optimistic locking - update fails if current content hash doesn't match
|===

**Response 200:**
[source,json]
----
{
  "success": true,
  "path": "introduction.goals",
  "location": {
    "file": "chapters/01_introduction.adoc",
    "start_line": 15,
    "end_line": 38
  },
  "previous_hash": "a1b2c3d4",
  "new_hash": "e5f6g7h8"
}
----

**Response 404:**
[source,json]
----
{
  "error": {
    "code": "PATH_NOT_FOUND",
    "message": "Section 'introduction.goals' not found"
  }
}
----

**Response 500:**
[source,json]
----
{
  "error": {
    "code": "WRITE_FAILED",
    "message": "Failed to write changes to file",
    "details": {
      "file": "chapters/01_introduction.adoc",
      "reason": "Permission denied"
    }
  }
}
----

'''

==== insert_content

Inserts content relative to a section.

**Use Case:** UC-09

[cols="1,3"]
|===
| Parameter | Description

| `path` (string, required)
| Hierarchical path to reference section

| `position` (string, required)
| Where to insert: "before", "after", or "append"

| `content` (string, required)
| Content to insert
|===

**Response 200:**
[source,json]
----
{
  "success": true,
  "inserted_at": {
    "file": "chapters/01_introduction.adoc",
    "line": 43
  }
}
----

'''

==== update_element (planned)

[NOTE]
====
This tool is planned but not yet implemented.
====

Replaces a specific element (code block, table, etc.).

**Use Case:** UC-10

[cols="1,3"]
|===
| Parameter | Description

| `path` (string, required)
| Hierarchical path to section

| `index` (int, required)
| Index of element within section (0-based)

| `content` (string, required)
| New element content
|===

=== Meta-Information Tools

==== get_metadata

Retrieves metadata about the project or a specific section.

**Use Case:** UC-06

[cols="1,3"]
|===
| Parameter | Description

| `path` (string, optional)
| Path to section. If None, returns project-level metadata.
|===

**Response 200 (Project):**
[source,json]
----
{
  "path": null,
  "project_name": "MCP Documentation Server",
  "total_files": 15,
  "total_sections": 87,
  "total_words": 12450,
  "last_modified": "2026-01-20T14:30:00Z",
  "formats": ["asciidoc", "markdown"]
}
----

**Response 200 (Section):**
[source,json]
----
{
  "path": "decisions",
  "title": "9. Architecture Decisions",
  "file": "chapters/09_decisions.adoc",
  "word_count": 2340,
  "last_modified": "2026-01-19T10:15:00Z",
  "subsection_count": 5,
  "includes": []
}
----

'''

==== get_dependencies (planned)

[NOTE]
====
This tool is planned but not yet implemented.
====

Retrieves include dependencies and cross-references.

**Use Case:** UC-06 (Extension)

'''

==== validate_structure

Validates the document structure.

**Use Case:** UC-07

**Response 200:**
[source,json]
----
{
  "valid": true,
  "errors": [],
  "warnings": [
    {
      "type": "orphaned_file",
      "path": "chapters/unused.adoc",
      "message": "File is not included in any document"
    }
  ],
  "validation_time_ms": 120
}
----

**Response 200 (with errors):**
[source,json]
----
{
  "valid": false,
  "errors": [
    {
      "type": "unresolved_include",
      "path": "chapters/01_introduction.adoc:15",
      "message": "Cannot resolve include: 'missing.adoc'"
    },
    {
      "type": "circular_include",
      "path": "chapters/03_context.adoc",
      "message": "Circular include detected: context.adoc -> technical.adoc -> context.adoc"
    }
  ],
  "warnings": []
}
----

=== System Tools (planned)

[NOTE]
====
The following tools are planned but not yet implemented. The MCP server currently rebuilds the index automatically after write operations.
====

==== get_health (planned)

Returns server health status and index information.

==== reindex (planned)

Triggers manual reindexing of the documentation.

== CLI Interface

NOTE: The CLI specification is in a separate file: `06_cli_specification.adoc`

The CLI interface allows using all MCP tools via the command line,
especially for LLMs without MCP support.

== Error Code Reference

Error responses are returned as dictionaries with an `error` key:

[cols="1,3"]
|===
| Code | Description

| `PATH_NOT_FOUND` | Requested section path does not exist
| `ELEMENT_NOT_FOUND` | Element at specified index does not exist
| `INVALID_TYPE` | Unknown element type
| `INVALID_POSITION` | Invalid insert position (must be "before", "after", or "append")
| `WRITE_FAILED` | Write operation failed (file permission, disk full, etc.)
|===

== Tool Summary

.Implemented MCP Tools
[cols="2,3"]
|===
| Tool | Description

| `get_structure` | Get hierarchical document structure
| `get_section` | Read content of a specific section
| `get_sections_at_level` | Get all sections at a nesting level
| `search` | Search documentation content
| `get_elements` | Get code blocks, tables, images, etc.
| `get_metadata` | Get project or section metadata
| `validate_structure` | Validate document structure
| `update_section` | Update section content
| `insert_content` | Insert content before/after sections
|===

.Planned Tools
[cols="2,3"]
|===
| Tool | Description

| `update_element` | Replace a specific element (code, table)
| `get_dependencies` | Get include dependencies
| `get_health` | Server health status
| `reindex` | Trigger manual reindexing
|===
