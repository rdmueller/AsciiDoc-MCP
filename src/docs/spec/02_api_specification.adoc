:jbake-title: API Specification
:jbake-type: page_toc
:jbake-status: published
:jbake-order: 2
ifndef::imagesdir[:imagesdir: ../../images]

:toc:

= MCP Documentation Server - API Specification
:sectnums:
:icons: font

== Overview

This specification defines the API endpoints of the MCP Documentation Server in OpenAPI style.

=== Base URL

[source]
----
Base URL: http://localhost:8000/api/v1
Protocol: MCP over HTTP/JSON
----

=== Authentication

[NOTE]
====
The current version does not require authentication (single-tenant).
API key authentication is planned for future versions.
====

== Data Models

=== SectionLocation

Describes the position of a section in a source file.

[source,json]
----
{
  "file": "string",        // Relative path to file
  "start_line": "integer", // 1-based start line
  "end_line": "integer"    // 1-based end line (inclusive)
}
----

=== Section

Represents a section in the document.

[source,json]
----
{
  "path": "string",           // Hierarchical path (e.g., "chapter-1.section-2")
  "title": "string",          // Section title
  "level": "integer",         // Nesting depth (1 = chapter)
  "location": "SectionLocation",
  "children": ["Section"]     // Subsections (optional)
}
----

=== Element

Represents a special element (table, code, diagram).

[source,json]
----
{
  "type": "string",           // "table" | "code" | "diagram" | "list" | "image"
  "path": "string",           // Path to containing section
  "index": "integer",         // Index within section
  "location": "SectionLocation",
  "preview": "string"         // Preview/title (optional)
}
----

=== SearchResult

Search result with context.

[source,json]
----
{
  "path": "string",           // Path to match location
  "line": "integer",          // Line number
  "context": "string",        // Surrounding text
  "score": "number"           // Relevance score (0-1)
}
----

=== Metadata

Metadata of a document or section.

[source,json]
----
{
  "path": "string",           // Path (or null for project)
  "file": "string",           // Source file
  "word_count": "integer",    // Word count
  "last_modified": "datetime",// Last modified (ISO 8601)
  "subsection_count": "integer",
  "includes": ["string"]      // List of include paths
}
----

=== ValidationResult

Result of structure validation.

[source,json]
----
{
  "valid": "boolean",
  "errors": [{
    "type": "string",         // "unresolved_include" | "circular_include" | ...
    "path": "string",
    "message": "string"
  }],
  "warnings": [{
    "type": "string",
    "path": "string", 
    "message": "string"
  }]
}
----

=== ErrorResponse

Standardized error response.

[source,json]
----
{
  "error": {
    "code": "string",         // Error code (e.g., "PATH_NOT_FOUND")
    "message": "string",      // Human-readable error message
    "details": "object"       // Additional details (optional)
  }
}
----

== API Endpoints

=== Navigation API

==== GET /structure

Retrieves the hierarchical document structure.

**Use Case:** UC-01

[cols="1,3"]
|===
| Parameter | Description

| `max_depth` (query, optional)
| Maximum depth of returned structure. Default: unlimited.
|===

**Response 200:**
[source,json]
----
{
  "root": {
    "path": "",
    "title": "MCP Documentation Server",
    "level": 0,
    "children": [
      {
        "path": "introduction",
        "title": "1. Introduction",
        "level": 1,
        "children": [
          {
            "path": "introduction.goals",
            "title": "1.1 Goals",
            "level": 2,
            "children": []
          }
        ]
      }
    ]
  },
  "total_sections": 42
}
----

**Response 500:**
[source,json]
----
{
  "error": {
    "code": "INDEX_NOT_READY",
    "message": "Server index is not initialized"
  }
}
----

'''

==== GET /section/{path}

Reads the content of a specific section.

**Use Case:** UC-02

[cols="1,3"]
|===
| Parameter | Description

| `path` (path, required)
| Hierarchical path to section (URL-encoded)
|===

**Response 200:**
[source,json]
----
{
  "path": "introduction.goals",
  "title": "1.1 Goals",
  "content": "= Goals\n\nThe main goals of this project are...",
  "location": {
    "file": "chapters/01_introduction.adoc",
    "start_line": 15,
    "end_line": 42
  },
  "format": "asciidoc"
}
----

**Response 404:**
[source,json]
----
{
  "error": {
    "code": "PATH_NOT_FOUND",
    "message": "Section 'introduction.goals' not found",
    "details": {
      "requested_path": "introduction.goals",
      "suggestions": ["introduction.quality-goals", "introduction.stakeholders"]
    }
  }
}
----

'''

==== GET /sections

Retrieves all sections at a specific level.

**Use Case:** UC-01 (Extension)

[cols="1,3"]
|===
| Parameter | Description

| `level` (query, required)
| Desired nesting depth (1 = chapter)
|===

**Response 200:**
[source,json]
----
{
  "level": 1,
  "sections": [
    {
      "path": "introduction",
      "title": "1. Introduction"
    },
    {
      "path": "constraints",
      "title": "2. Constraints"
    }
  ],
  "count": 12
}
----

=== Content Access API

==== GET /elements

Retrieves elements of a specific type.

**Use Case:** UC-05

[cols="1,3"]
|===
| Parameter | Description

| `type` (query, required)
| Element type: `diagram`, `table`, `code`, `list`, `image`

| `path` (query, optional)
| Restriction to specific section
|===

**Response 200:**
[source,json]
----
{
  "type": "diagram",
  "elements": [
    {
      "type": "diagram",
      "path": "context.technical",
      "index": 0,
      "location": {
        "file": "chapters/03_context.adoc",
        "start_line": 25,
        "end_line": 45
      },
      "preview": "[plantuml, technical-context, svg]"
    }
  ],
  "count": 8
}
----

**Response 400:**
[source,json]
----
{
  "error": {
    "code": "INVALID_TYPE",
    "message": "Unknown element type 'charts'",
    "details": {
      "valid_types": ["diagram", "table", "code", "list", "image"]
    }
  }
}
----

'''

==== POST /search

Searches documentation content.

**Use Case:** UC-04

**Request Body:**
[source,json]
----
{
  "query": "string",          // Search term (required)
  "scope": "string",          // Restriction to path (optional)
  "case_sensitive": false,    // Case sensitivity (optional)
  "max_results": 50           // Maximum results (optional)
}
----

**Response 200:**
[source,json]
----
{
  "query": "atomic write",
  "results": [
    {
      "path": "decisions.adr-004",
      "line": 12,
      "context": "...implements atomic writes using a backup-and-replace strategy...",
      "score": 0.95
    },
    {
      "path": "runtime.update-scenario",
      "line": 5,
      "context": "...The process must be atomic to ensure data integrity...",
      "score": 0.78
    }
  ],
  "total_results": 2,
  "search_time_ms": 45
}
----

=== Content Manipulation API

==== PUT /section/{path}

Updates the content of a section.

**Use Case:** UC-03

[cols="1,3"]
|===
| Parameter | Description

| `path` (path, required)
| Hierarchical path to section
|===

**Request Body:**
[source,json]
----
{
  "content": "string",        // New section content (required)
  "preserve_title": true      // Keep title (optional, default: true)
}
----

**Response 200:**
[source,json]
----
{
  "success": true,
  "path": "introduction.goals",
  "location": {
    "file": "chapters/01_introduction.adoc",
    "start_line": 15,
    "end_line": 38
  },
  "previous_hash": "a1b2c3d4",
  "new_hash": "e5f6g7h8"
}
----

**Response 404:**
[source,json]
----
{
  "error": {
    "code": "PATH_NOT_FOUND",
    "message": "Section 'introduction.goals' not found"
  }
}
----

**Response 500:**
[source,json]
----
{
  "error": {
    "code": "WRITE_FAILED",
    "message": "Failed to write changes to file",
    "details": {
      "file": "chapters/01_introduction.adoc",
      "reason": "Permission denied"
    }
  }
}
----

'''

==== POST /section/{path}/insert

Inserts content relative to a section.

**Use Case:** UC-09

[cols="1,3"]
|===
| Parameter | Description

| `path` (path, required)
| Hierarchical path to reference section
|===

**Request Body:**
[source,json]
----
{
  "position": "string",       // "before" | "after" | "append" (required)
  "content": "string"         // Content to insert (required)
}
----

**Response 200:**
[source,json]
----
{
  "success": true,
  "inserted_at": {
    "file": "chapters/01_introduction.adoc",
    "line": 43
  }
}
----

'''

==== PUT /element/{path}/{index}

Replaces a specific element.

**Use Case:** UC-10

[cols="1,3"]
|===
| Parameter | Description

| `path` (path, required)
| Hierarchical path to section

| `index` (path, required)
| Index of element within section (0-based)
|===

**Request Body:**
[source,json]
----
{
  "content": "string"         // New element content (required)
}
----

**Response 200:**
[source,json]
----
{
  "success": true,
  "element": {
    "type": "table",
    "path": "quality.performance",
    "index": 0
  }
}
----

**Response 404:**
[source,json]
----
{
  "error": {
    "code": "ELEMENT_NOT_FOUND",
    "message": "No element at index 2 in section 'quality.performance'"
  }
}
----

=== Meta-Information API

==== GET /metadata

Retrieves metadata.

**Use Case:** UC-06

[cols="1,3"]
|===
| Parameter | Description

| `path` (query, optional)
| Path to section. Without: project metadata
|===

**Response 200 (Project):**
[source,json]
----
{
  "path": null,
  "project_name": "MCP Documentation Server",
  "total_files": 15,
  "total_sections": 87,
  "total_words": 12450,
  "last_modified": "2026-01-20T14:30:00Z",
  "formats": ["asciidoc", "markdown"]
}
----

**Response 200 (Section):**
[source,json]
----
{
  "path": "decisions",
  "title": "9. Architecture Decisions",
  "file": "chapters/09_decisions.adoc",
  "word_count": 2340,
  "last_modified": "2026-01-19T10:15:00Z",
  "subsection_count": 5,
  "includes": []
}
----

'''

==== GET /dependencies

Retrieves include dependencies.

**Use Case:** UC-06 (Extension)

**Response 200:**
[source,json]
----
{
  "include_tree": {
    "arc42.adoc": [
      "chapters/01_introduction.adoc",
      "chapters/02_constraints.adoc",
      "chapters/03_context.adoc"
    ]
  },
  "cross_references": [
    {
      "from": "decisions.adr-001",
      "to": "constraints.technical",
      "type": "reference"
    }
  ]
}
----

'''

==== POST /validate

Validates the document structure.

**Use Case:** UC-07

**Response 200:**
[source,json]
----
{
  "valid": true,
  "errors": [],
  "warnings": [
    {
      "type": "orphaned_file",
      "path": "chapters/unused.adoc",
      "message": "File is not included in any document"
    }
  ],
  "validation_time_ms": 120
}
----

**Response 200 (with errors):**
[source,json]
----
{
  "valid": false,
  "errors": [
    {
      "type": "unresolved_include",
      "path": "chapters/01_introduction.adoc:15",
      "message": "Cannot resolve include: 'missing.adoc'"
    },
    {
      "type": "circular_include",
      "path": "chapters/03_context.adoc",
      "message": "Circular include detected: context.adoc -> technical.adoc -> context.adoc"
    }
  ],
  "warnings": []
}
----

=== System API

==== GET /health

Health check endpoint.

**Response 200:**
[source,json]
----
{
  "status": "healthy",
  "index_ready": true,
  "indexed_files": 15,
  "uptime_seconds": 3600
}
----

'''

==== POST /reindex

Triggers reindexing.

**Response 202:**
[source,json]
----
{
  "status": "reindexing",
  "message": "Reindexing started in background"
}
----

== CLI Interface

NOTE: The CLI specification is in a separate file: `06_cli_specification.adoc`

The CLI interface allows using all MCP tools via the command line,
especially for LLMs without MCP support.

== Error Code Reference

[cols="1,1,3"]
|===
| Code | HTTP Status | Description

| `PATH_NOT_FOUND` | 404 | Requested path does not exist
| `ELEMENT_NOT_FOUND` | 404 | Element at specified index does not exist
| `INVALID_TYPE` | 400 | Unknown element type
| `INVALID_POSITION` | 400 | Invalid insert position
| `INVALID_QUERY` | 400 | Invalid search query
| `WRITE_FAILED` | 500 | Write operation failed
| `INDEX_NOT_READY` | 503 | Index not yet initialized
| `PARSE_ERROR` | 500 | Error parsing a file
|===

== Rate Limiting

[NOTE]
====
The current version has no rate limiting.
For production environments, the following is recommended:

* 100 requests/minute for read operations
* 20 requests/minute for write operations
====

== Versioning

The API uses URL-based versioning (`/api/v1/`).

Changes within a version are backward compatible:

* New optional parameters
* New response fields
* New endpoints

Breaking changes require a new version (`/api/v2/`).
